---

macros:
  - &OK
    m: true
  - &KO
    m: false

match:

#  - p: [ { _: { a: [_x] } } ]
#    d: [ {a: [1]}, {a: [2}] ]
#    v: null

  - p: [ { _: [ _x ] } ]
    d: [ [1], [2], [3] ]
    v: {_loop_: [{_x: 1}, {_x: 2}, {_x: 3}], m: true}

#  - p: [ { _: { a: [ _x, _x ] } } ]
#    d: [ { a: [ [ 1, 1 ], [ 2, 2 ], [ 3, 3]] } ]
#    v: null

  # - { p: 1, d: 2, v: *OK }

  - { p: a, d: a, v: *OK }
  - { p: a, d: b, v: *KO }
  - { p: [1, 2, 3], d: [1, 2, 3], v: *OK }
  - { p: [ { _: _i } ], d: [1, 2, 3], v: { <<: *OK, _loop_: [ { _i: 1 }, { _i: 2 }, { _i: 3 } ]}}
  - { p: [ { _: _i } ], d: [1, 2], v: { <<: *OK, _loop_: [ { _i: 1 }, { _i: 2 } ]}}
  - { p: { a: _a, _b: _c }, d: { a: 1, b: 2, c: 3 }, v: {_a: 1, _loop_: [{_b: b, _c: 2}, {_b: c, _c: 3}], m: true} }

  - p: &ip_match_pattern
      - { _: { ip: _ip, name: _name } }
    d: &ip_match_data
      - { ip: 1.1.1.1, name: one }
      - { ip: 1.1.1.2, name: two }
      - { ip: 1.1.1.3, name: three }
    v:
      m: true
      _loop_:
        - { _ip: 1.1.1.1, _name: one }
        - { _ip: 1.1.1.2, _name: two }
        - { _ip: 1.1.1.3, _name: three }

  - d:
      a: { x: 1, y: 2 }
      b: { x: 3, y: 4 }
    p:
      _b: { x: _x, y: _y }
    v: {_loop_: [{_b: a, _x: 1, _y: 2}, {_b: b, _x: 3, _y: 4}], m: true}

  - d:
      h: foo
      a: { x: 1, y: 2 }
      b: { x: 3, y: 4 }
      t: bar
    p:
      h: _h
      _b: { x: _x, y: _y }
      t: _t
    v: {_h: foo, _loop_: [{_b: a, _x: 1, _y: 2}, {_b: b, _x: 3, _y: 4}], _t: bar, m: true }

  - d:
      a: { x: 1, y: 2 }
      b: { x: 3, y: 4 }
    p:
      z: 1
      _b: { x: _x, y: _y }
    v: {_loop_: [{_b: a, _x: 1, _y: 2}, {_b: b, _x: 3, _y: 4}], m: false}


bind:

  - p: [ { _x_: _x } ]
    e: { _loop_: [ { _x: 1 }, { _x: 2 }, { _x: 3 } ] }
    v: [ 1, 2, 3 ]

#  - p: [ { _x_: { a: [ _x, _x ] } } ]
#    e: { loop_: [ { _x: 1 }, { _x: 2 }, { _x: 4 } ] }
#    v: [ 1, 2, 3 ]

#  - { p: 0, e: {}, v: null}

  - p: &ip_bind_pattern
      names: [ { _name_: _name } ]
      ips: [ { _ip_: _ip } ]
      by_name:
        _name: { name: _name, ip: _ip }
      by_ip:
        _ip: { name: _name, ip: _ip }
    e:
      _loop_:
        - { _ip: 1.1.1.1, _name: one }
        - { _ip: 1.1.1.2, _name: two }
        - { _ip: 1.1.1.3, _name: three }
    v: &ip_bound_data
      ips: [ 1.1.1.1, 1.1.1.2, 1.1.1.3 ]
      names: [ one, two, three ]
      by_ip:
        1.1.1.1: { ip: 1.1.1.1, name: one }
        1.1.1.2: { ip: 1.1.1.2, name: two }
        1.1.1.3: { ip: 1.1.1.3, name: three }
      by_name:
        one: { ip: 1.1.1.1, name: one }
        two: { ip: 1.1.1.2, name: two }
        three: { ip: 1.1.1.3, name: three }

matchAndBind:
  
  - d: { x: a, y: b, z: c }
    m: { _k: _v }
    b: { _v: _k }
    v: { a: x, b: y, c: z }

  - d: { a: { b: c }, d: { e: f }}
    m: { _x: { _y: _z }}
    b: { _z: { _y: _x }}
    v: { c: { b: a, e: d }, f: { b: a, e: d }}

  - d:
      a:
        b: c
      d:
        e: f
    m:
      _x:
        _y: _z
    b:
      _z:
        _y: _x
    v:
      c:
        b: a
        e: d
      f:
        b: a
        e: d
      
  - d: *ip_match_data
    m: *ip_match_pattern
    b: *ip_bind_pattern
    v: *ip_bound_data

#  - d:
#      h: foo
#      a: { x: 1, y: 2 }
#      b: { x: 3, y: 4 }
#      t: bar
#    m:
#      h: _h
#      _b: { x: _x, y: _y }
#      t: _t
#    b:
#      # - [ _h, _t ]
#      - { _b: { n: _b, x: _x, y: _y } }

bind_hide:

  - p: a
    e: {}
    v: a

  - p: _a
    e: &e1 { _a: 1 }
    v: 1

  - p: [ _a ]
    e: *e1
    v: [ 1 ]

  - p: [ _a, { x: _a } ]
    e: *e1
    v: [ 1, { x: 1 } ]

  - p: [ { _a: _b } ]
    e:
      _a:
        - { _a: x }
        - { _a: y, _b: 8 }
      _b: 9
    v:
      - x: 9
        y: 8
